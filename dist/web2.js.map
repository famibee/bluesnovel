{"version":3,"file":"web2.js","sources":["../src/ts/Memento.ts","../src/ts/SysBase.ts","../src/web.ts"],"sourcesContent":["/* ***** BEGIN LICENSE BLOCK *****\n\tCopyright (c) 2024-2024 Famibee (famibee.blog38.fc2.com)\n\n\tThis software is released under the MIT License.\n\thttp://opensource.org/licenses/mit-license.php\n** ***** END LICENSE BLOCK ***** */\n\nexport abstract class BaseMemento {\n\tabstract readonly\tnm: string;\t\t// 適当な名を付けて\n\tconstructor(protected readonly stt = '') {}\n\n\tabstract\trestore(): void;\t// this.stt から\n};\n\n\nexport class Caretaker {\n\t#key = '';\n\tpush(key: string) {\n\t\tthis.update = this.#update;\n\n\t\tthis.push = (key: string)=> {\n\t\t\tthis.#key = key;\n\t\t\tthis.#idxHistory = this.#aKeyHistory.push(key) -1;\n\t\t\tthis.#hScr2AState[key] = {};\n\t\t};\n\t\tthis.push(key);\n\t}\n\n\t#hScr2AState: {[key: string]: {[nm: string]: BaseMemento}}\t= {};\n\tupdate(_genMeMe: ()=> BaseMemento) {return}\n\t#update(genMeMe: ()=> BaseMemento) {\n\t\tif (this.#idxHistory < this.#aKeyHistory.length -1) return;\n\n\t\tconst m = genMeMe();\n\t\tthis.#hScr2AState[this.#key]![m.nm] = m;\nconsole.log(`fn:Memento.ts update -- key(${this.#key}) MeMe:%o`, m);\n\t}\n\n\tundo(key: string) {\nconsole.log(`fn:Memento.ts = undo key=(${key})`);\n\t\tconst h = this.#hScr2AState[key];\n\t\tif (! h) throw `undo Err key:${key}`;\n\n\t\tfor (const meme of Object.values(h)) meme.restore();\n\t}\n\n\t#aKeyHistory: string[]\t= [];\n\t#idxHistory\t= 0;\n\t// 前のキーへ移動\n\tprevKey(): boolean {\nconsole.log(`fn:Memento.ts -- beforeKey --`);\n\t\tif (this.#idxHistory <= 0) return false;\n\n\t\tthis.undo(this.#aKeyHistory[--this.#idxHistory]!);\n\t\treturn true;\n\t}\n\t// 後のキーへ移動\n\tnextKey(): boolean {\nconsole.log(`fn:Memento.ts -- afterKey --`);\n\t\tif (this.#aKeyHistory.length -1 <= this.#idxHistory) return false;\n\n\t\tthis.undo(this.#aKeyHistory[++this.#idxHistory]!);\n\t\treturn true;\n\t}\n\tisLast() {return this.#aKeyHistory.length -1 === this.#idxHistory}\n}\n","/* ***** BEGIN LICENSE BLOCK *****\n\tCopyright (c) 2018-2024 Famibee (famibee.blog38.fc2.com)\n\n\tThis software is released under the MIT License.\n\thttp://opensource.org/licenses/mit-license.php\n** ***** END LICENSE BLOCK ***** */\n\nimport type {HPlugin, ISysBase, T_SysBaseLoadedParams} from './CmnInterface';\nimport type {IConfig, IFn2Path, ISysRoots} from './ConfigBase';\nimport {Caretaker} from './Memento';\n\n\n// React Developer Toolsのインストールを推されるコンソールメッセージを消す\n(window as any).__REACT_DEVTOOLS_GLOBAL_HOOK__ = {isDisabled: true};\n\ntype HSysBaseArg = {\n\tcur\t\t: string;\n\tcrypto\t: boolean;\n\tdip\t\t: string;\n}\n\nconst\tSN_ID\t= 'skynovel';\n\n\nexport class SysBase implements ISysRoots, ISysBase {\n\tconstructor(readonly hPlg: HPlugin = {}, readonly arg: HSysBaseArg) {}\n\tprotected async loaded(...[_hPlg,]: T_SysBaseLoadedParams) {\n\t\tdocument.head.insertAdjacentHTML('beforeend',\n`<style type=\"text/css\">\n\tbody {\n\t\tbackground-color: black;\n\t}\n\t:-webkit-full-screen canvas#skynovel {width: 100%; height: 100%; object-fit: contain;}\n\t:-moz-full-screen canvas#skynovel {width: 100%; height: 100%; object-fit: contain;}\n\t:full-screen canvas#skynovel {width: 100%; height: 100%; object-fit: contain;}\n</style>`);\n\n\t\tPromise.all([\n\t\t\timport('react-dom/client'),\n\t\t\timport('../components/Main'),\n\t\t\timport('./Config'),\n\t\t]).then(async ([{createRoot}, {initMain, start}, {Config}])=> {\n\t\t\tconst runSub: ()=> Promise<HTMLDivElement> = async ()=> {\n\t\t\t\tconst cfg = await Config.generate(this);\n\t\t\t\tdocument.body.style.backgroundColor = cfg.oCfg.init.bg_color;\n\n\t\t\t\tlet e = <HTMLDivElement>document.getElementById(SN_ID);\n\t\t\t\tif (e) {\n\t\t\t\t\tconst clone_cvs = <HTMLDivElement>e.cloneNode(true);\n\t\t\t\t\tclone_cvs.id = SN_ID;\n\t\t\t\t}\n\t\t\t\telse {\t// 自動的に作ってくれるが、どうも appendChild に遅延があるので\n\t\t\t\t\te = document.createElement('div');\n\t\t\t\t\te.id = SN_ID;\n\t\t\t\t\tdocument.body.appendChild(e);\n\t\t\t\t}\n\t\t\t\treturn e;\n\t\t\t}\n\t\t\tconst heStage = await runSub();\n\t\t\tinitMain(createRoot(heStage), {heStage, sys: this});\t// React 初期表示\n\n\t\t\tPromise.all([\n\t\t\t\timport('@pixi/assets'),\n\t\t\t\timport('@pixi/extensions'),\n\t\t\t\timport('../ts/ScriptMng'),\n\t\t\t]).then(async ([{Assets}, {extensions, ExtensionType}, {ScriptMng}])=> {\n\t\t\t\tawait Assets.init({basePath: location.origin});\n\t\t\t\textensions.add({\n\t\t\t\t\textension: {\n\t\t\t\t\t\ttype: ExtensionType.LoadParser,\n\t\t\t\t\t\tname: 'sn-loader',\n\t\t\t\t\t\t//priority: LoaderParserPriority.High,\n\t\t\t\t\t},\n\t\t\t\t\ttest: (url: string)=> url.endsWith('.sn'),\n\t\t\t\t\tload: (url: string)=> new Promise(async (re, rj)=> {\n\t\t\t\t\t\tconst res = await this.fetch(url);\n\t\t\t\t\t\tif (! res.ok) {rj(`sn-loader fetch err:`+ res.statusText); return}\n\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tre(await this.dec('sn', await res.text()));\n\t\t\t\t\t\t} catch (e) {rj(`sn-loader err url:${url} ${e}`)}\n\t\t\t\t\t}),\n\t\t\t\t});\n\t\t\t\tthis.load = url=> Assets.load(url);\n\n\t\t\t\tconst scrMng = new ScriptMng(this);\n\t\t\t\tawait start(scrMng);\t// SKYNovel 開始\n\t\t\t\t// this.run = async ()=> {\n\t\t\t\t// \tconst heStage = await runSub();\n\t\t\t\t// \tinitMain(createRoot(heStage), {heStage, sys: this});\n\n\t\t\t\t// \tconst scrMng = new ScriptMng(this);\n\t\t\t\t// \tawait start(scrMng);\n\t\t\t\t// };\n\t\t\t});\n\t\t});\n\t}\n\tload = async (_url: string)=> '';\n\n\tfetch = (url: string, init?: RequestInit)=> fetch(url, init);\n\n\treadonly\t#ct\t= new Caretaker;\n\tget caretaker() {return this.#ct}\n\n\n\tcfg: IConfig;\n\tasync loadPath(hPathFn2Exts: IFn2Path, cfg: IConfig) {\n\t\tthis.cfg = cfg;\n\n\t\tconst fn = this.arg.cur +'path.json';\n\t\tconst res = await this.fetch(fn);\n\t\tif (! res.ok) throw Error(res.statusText);\n\n\t\tconst src = await res.text();\n\t\tconst oJs = JSON.parse(await this.dec(fn, src));\n\t\tfor (const [nm, v] of Object.entries(oJs)) {\n\t\t\tconst h = hPathFn2Exts[nm] = <any>v;\n\t\t\tfor (const [ext, w] of Object.entries(h)) {\n\t\t\t\tif (ext !== ':cnt') h[ext] = this.arg.cur + w;\n\t\t\t}\n\t\t}\n\t}\n\n\n\tprotected async run() {}\n\n\n\tprotected $path_downloads\t= '';\n\tget path_downloads() {return this.$path_downloads}\n\tprotected $path_userdata\t= '';\n\tget path_userdata() {return this.$path_userdata}\n\n\treadonly dec = (_ext: string, tx: string)=> Promise.resolve(tx);\n\treadonly hash = (_str: string)=> '';\n\n}\n","/* ***** BEGIN LICENSE BLOCK *****\n\tCopyright (c) 2024-2024 Famibee (famibee.blog38.fc2.com)\n\n\tThis software is released under the MIT License.\n\thttp://opensource.org/licenses/mit-license.php\n** ***** END LICENSE BLOCK ***** */\n\nimport type {HPlugin, IPlugin, IPluginInitArg} from './ts/CmnInterface';\nexport type {HPlugin, IPlugin, IPluginInitArg};\n\nimport {SysBase} from './ts/SysBase';\nimport type {T_SysBaseParams} from './ts/CmnInterface';\n\nexport class SysWeb extends SysBase {\n\tconstructor(...[hPlg = {}, arg = {cur: 'prj/', crypto: false, dip: ''}]: T_SysBaseParams) {\t// DOMContentLoaded は呼び出し側でやる\n\t\tsuper(hPlg, arg);\n// console.log(`fn:web.ts line:19 hPlg:%o`, this.hPlg);\n\t\t//TODO: プラグイン\n\t\tqueueMicrotask(async ()=> this.loaded(hPlg, arg));\n\t}\n\n}\n\n// import {CmnLib, argChk_Num, argChk_Boolean} from './ts/CmnLib';\n// import {Layer} from './ts/Layer';\n// export {SysWeb, CmnLib, argChk_Num, argChk_Boolean, Layer};\n"],"names":["BaseMemento","stt","Caretaker","#key","key","#update","#idxHistory","#aKeyHistory","#hScr2AState","_genMeMe","genMeMe","m","h","meme","SN_ID","SysBase","hPlg","arg","_hPlg","n","createRoot","initMain","start","Config","heStage","cfg","e","clone_cvs","Assets","extensions","ExtensionType","ScriptMng","url","re","rj","res","scrMng","_url","init","#ct","hPathFn2Exts","fn","src","oJs","nm","v","ext","w","_ext","tx","_str","SysWeb"],"mappings":"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"}