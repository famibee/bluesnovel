{"version":3,"file":"ScriptMng.js","sources":["../src/ts/AnalyzeTagArg.ts","../src/ts/Grammar.ts","../src/ts/ScriptMng.ts"],"sourcesContent":["/* ***** BEGIN LICENSE BLOCK *****\n\tCopyright (c) 2018-2024 Famibee (famibee.blog38.fc2.com)\n\n\tThis software is released under the MIT License.\n\thttp://opensource.org/licenses/mit-license.php\n** ***** END LICENSE BLOCK ***** */\n\nexport interface PRM {\n\tval\t\t: string;\n\tdef?\t: string;\n};\nexport interface HPRM {\n\t[key: string]: PRM,\n};\n\nexport interface PRM_RANGE {\n\tk_ln\t: number;\n\tk_ch\t: number;\n\tv_ln\t: number;\n\tv_ch\t: number;\n\tv_len\t: number;\n};\n\nexport class AnalyzeTagArg {\n\t// 87 match 2725 step(0.5ms) PCRE2 https://regex101.com/r/aeN57J/1\n\t/*\n;[^\\n]*\n|\t(?<key>[^\\s=\"'#|;]+)\n\t(?: \\s | ;[^\\n]*\\n)*\n\t=\n\t(?: \\s | ;[^\\n]*\\n)*\n\t(?:\t(?<val> [^\\s\"'#|;]+)\n\t|\t([\"'#]) (?<val2>.*?) \\3 )\n\t(?: \\|\n\t\t(?: (?<def> [^\\s\"'#;]+)\n\t|\t([\"'#]) (?<def2>.*?) \\6 ) )?\n|\t(?<literal>[^\\s;]+)\n\t*/\n\treadonly\t#REG_TAGARG\t= /;[^\\n]*|(?<key>[^\\s=\"'#|;]+)(?:\\s|;[^\\n]*\\n)*=(?:\\s|;[^\\n]*\\n)*(?:(?<val>[^\\s\"'#|;]+)|([\"'#])(?<val2>.*?)\\3)(?:\\|(?:(?<def>[^\\s\"'#;]+)|([\"'#])(?<def2>.*?)\\6))?|(?<literal>[^\\s;]+)/g;\n\n\t// 【属性 = 値 | 省略値】の分析\n\tparse(args: string): void {\n\t\tthis.#hPrm = {};\n\t\tthis.#isKomeParam = false;\n\t\tfor (const {groups} of args.matchAll(this.#REG_TAGARG)) {\n\t\t\tconst {key, val, val2, def, def2, literal} = groups!;\n\t\t\tif (key) this.#hPrm[key] = {\n\t\t\t\tval: val ?? val2 ?? '',\n\t\t\t\tdef: def ?? def2\n\t\t\t};\n\t\t\telse if (literal) {\n\t\t\t\tif (literal === '*') this.#isKomeParam = true;\n\t\t\t\telse this.#hPrm[literal] = {val: '1'};\n\t\t\t}\n\t\t}\n\t}\n\n\t// 属性と値の位置をまとめて返す\n\tparseinDetail(token: string, lenNm: number, ln: number, ch: number): {[key: string]: PRM_RANGE} {\n\t\tconst hRng: {[key: string]: PRM_RANGE} = {};\n\n\t\tconst args = token.slice(1+lenNm, -1);\n\t\tfor (const {groups, index, 0: z} of args.matchAll(this.#REG_TAGARG)) {\n\t\t\tif (index === undefined) continue;\n\t\t\tconst {key, val, val2='', literal} = groups!;\n\t\t\tif (literal) {\n\t\t\t\tif (literal.endsWith('=')) {\n\t\t\t\t\tconst lenVnm = literal.length -1;\n\t\t\t\t\tconst {ch: k_ch} = this.#idx2LnCol(lenNm, ln, ch, args, index +lenVnm);\n\t\t\t\t\thRng[literal.slice(0, -1)] = {\n\t\t\t\t\t\tk_ln: ln,\n\t\t\t\t\t\tk_ch: k_ch -lenVnm,\n\t\t\t\t\t\tv_ln: ln,\n\t\t\t\t\t\tv_ch: k_ch +1,\n\t\t\t\t\t//\tv_ch: ch +1+lenNm +literal.length +1,\n\t\t\t\t\t\tv_len: 0,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (! key) continue;\n\n\t\t\tconst {ln: k_ln, ch: k_ch} = this.#idx2LnCol(lenNm, ln, ch, args, index);\n\t\t\tconst {ln: v_ln, ch: v_ch} = this.#idx2LnCol(lenNm, ln, ch, args, index +z.lastIndexOf(val ?? val2 ?? '') -(val ?0 :1));\n\t\t\thRng[key] = {k_ln, k_ch, v_ln, v_ch, v_len: val ?val.length :val2.length +2};\n\t\t}\n\n\t\treturn hRng;\n\t}\n\t\t#idx2LnCol(lenNm: number, ln: number, ch: number, args: string, idx: number): {ln: number; ch: number;} {\n\t\t\tconst sBefore = args.slice(0, idx);\n\t\t\tconst a = sBefore.split('\\n');\n\t\t\tconst len = a.length;\n\t\t\treturn {\n\t\t\t\tln\t: ln +len -1,\n\t\t\t\tch\t: len < 2 ?ch +1+lenNm +idx :a.at(-1)!.length,\n\t\t\t};\n\t\t}\n\n\t#hPrm: HPRM\t= {};\n\tget hPrm() {return this.#hPrm}\n\n\t#isKomeParam\t= false;\n\tget isKomeParam() {return this.#isKomeParam}\n\n}\n","/* ***** BEGIN LICENSE BLOCK *****\n\tCopyright (c) 2019-2024 Famibee (famibee.blog38.fc2.com)\n\n\tThis software is released under the MIT License.\n\thttp://opensource.org/licenses/mit-license.php\n** ***** END LICENSE BLOCK ***** */\n\nimport {AnalyzeTagArg} from \"./AnalyzeTagArg\";\nimport {getFn} from \"./CmnLib\";\nimport {IConfig, SEARCH_PATH_ARG_EXT} from \"./ConfigBase\";\n\n\nexport type HArg = {\n\t':タグ名'?\t: string;\n\n\tlayer?\t: string;\t// レイヤ系\n\tclass?\t: string;\n\tindex?\t: number;\n\tdive?\t: string;\n\tpage?\t: string;\n\talpha?\t: number;\n\tpivot_x?: number;\n\tpivot_y?: number;\n\trotation?\t: number;\n\tscale_x?: number;\n\tscale_y?: number;\n\tvisible?: boolean;\n\tblendmode?\t: string;\n\n\tleft?\t: number;\n\ttop?\t: number;\n\twidth?\t: number;\n\theight?\t: number;\n\tpl?\t\t: number;\n\tpr?\t\t: number;\n\tpt?\t\t: number;\n\tpb?\t\t: number;\n\n\trotate?\t: number;\n\tin_style?\t: string;\n\tout_style?\t: string;\n\tffs?\t: string;\n\tnoffs?\t: string;\n\tkinsoku_sol?\t: string;\n\tkinsoku_eol?\t: string;\n\tkinsoku_dns?\t: string;\n\tkinsoku_bura?\t: string;\n\tbura?\t: boolean;\n\tbreak_fixed?\t\t: boolean;\n\tbreak_fixed_left?\t: number;\n\tbreak_fixed_top?\t: number;\n\n\ttime?\t: number;\n\trule?\t: string;\n\tglsl?\t: string;\n\trender?\t: boolean;\n\n\tpos?\t: string;\n\ttext?\t: string;\n\twait?\t: number;\n\trecord?\t: boolean;\n\tpic?\t: string;\n\tenabled?: boolean;\n\thint?\t\t: string;\n\thint_style?\t: string;\n\thint_opt?\t: string;\n\tclickse?\t: string;\n\tenterse?\t: string;\n\tleavese?\t: string;\n\tclicksebuf?\t: string;\n\tentersebuf?\t: string;\n\tleavesebuf?\t: string;\n\tonenter?\t: string;\n\tonleave?\t: string;\n\n\tt?\t: string;\n\tr?\t: string;\n\texp?\t: string;\n\tchar?\t: string;\n\tsesame?\t: string;\n\tcast?\t: string;\n\tval?\t: string;\n\tflags?\t: string;\n\treg?\t: string;\n\tlen?\t: string;\n\turl?\t: string;\n\tformat?\t: string;\n\tchain?\t: string;\n\tpath?\t: string;\n\n\tfn?\t\t: string;\n\tface?\t: string;\n\tlabel?\t: string;\n\tcall?\t: boolean;\n\tglobal?\t: boolean;\n\tname?\t: string;\n\tclear_local_event?\t: boolean;\n\n\tstyle?\t\t\t: string;\n\tstyle_hover?\t: string;\n\tstyle_clicked?\t: string;\n\tr_style?\t\t: string;\n\tr_style_hover?\t: string;\n\tr_style_clicked?: string;\n\tr_align?\t: string;\n\n\tb_width?\t: string;\n\tb_height?\t: string;\n\tb_color?\t: string;\n\tb_alpha?\t: number;\n\tb_alpha_isfixed?\t: boolean;\n\tb_pic?\t\t: string;\n\tback_clear?\t: string;\n\n\tmax_col?\t: string;\n\tmax_row?\t: string;\n\tbura_col?\t: string;\n\tchk_overrow?\t: string;\n\n\tdx?\t: number;\n\tdy?\t: number;\n\n\tkey?\t: string;\n\ttype?\t: string;\t// 3Dレイヤで使用\n\tcamera_target?\t: string;\n\n\tbreakout?\t: Function;\n\targ?\t: HArg;\n\tfnc?\t: ()=> void;\n\n\tfilter?\t: string;\n\tmatrix?\t: string;\n\tclear_filter?\t: boolean;\n\tenable_filter?\t: boolean;\n\n\tease?\t: string;\n\tcanskip?\t:boolean;\n\n\tcentering?\t:boolean;\n\tx?\t\t: number | string;\n\ty?\t\t: number | string;\n\n\tid?\t\t\t: string;\n\tsrc?\t\t: string;\n\tvar_name?\t: string;\n\tset_fnc?\t: string;\n\tbreak_fnc?\t: string;\n\n\tswipe?\t: string;\n\tf2tap?\t: string;\n\tf2move?\t: string;\n\tf3tap?\t: string;\n\n\tfrom?\t: number;\n\tto?\t\t: number | string;\n\tplace?\t: number;\n\tadd?\t: string;\n\tdel?\t: string;\n\n\tbuf?\t: string;\t// 音系\n\tbuf2?\t: string;\n\tloop?\t: boolean;\n\tvolume?\t: number;\n\tret_ms?\t: number;\n\tend_ms?\t: number;\n\tjoin?\t: boolean;\n\tdo_rec?\t: boolean;\n\tpan?\t: number;\n\tstop?\t: boolean;\n\n\tclear?\t: boolean;\n\n\t// デザインモード\n\t':id_dc'?\t: string;\n\t':id_tag'?\t: string;\n\t':path'?\t: string;\n\t':ln'?\t\t: number;\n\t':col_s'?\t: number;\n\t':col_e'?\t: number;\n\t':idx_tkn'?\t: number;\n\t':token'?\t: string;\n\t':redraw'?\t: boolean;\n\tdesign_unit?: boolean;\t// デザインモードでこのマクロへの引数変更とするか（内部をサーチさせない）\n\n//\tstepin?\t\t: boolean;\t\t// 拡張機能のみ使用：false指定でステップインしない\n//\tnowarn_unused?\t: boolean;\t// 拡張機能のみ使用：未使用警告を出さない\n}\nexport interface ITag { (hArg: HArg): boolean; }\nexport interface IHTag { [name: string]: ITag; }\n\n\nexport type Script = {\n\taToken\t: string[];\t\t// トークン群\n\tlen\t\t: number;\t\t// トークン数\n\taLNum\t: number[];\t\t// トークンの行番号\n};\n\n\nexport const\tREG_TAG\t= /(?<name>[^\\s;\\]]+)/;\t// test用にexport\nexport function\ttagToken2Name_Args(token: string): [name: string, args: string] {\n\tconst e = REG_TAG.exec(token.slice(1, -1));\n\tconst g = e?.groups;\n\tif (! g) throw `タグ記述【${token}】異常です(タグ解析)`;\n\n\tconst nm = g.name!;\n\treturn [nm, token.slice(1 +nm.length, -1)];\n}\nexport function\ttagToken2Name(token: string): string {\n\tconst e = REG_TAG.exec(token.slice(1));\n\tconst g = e?.groups;\n\tif (! g) throw `タグ記述【${token}】異常です(タグ解析)`;\n\n\treturn g.name!;\n}\n\nexport function\tsplitAmpersand(token: string): {\n\t\tname: string;\n\t\ttext: string;\n\t\tcast: string | undefined;\n} {\t// テスト用にpublic\n\tconst equa = token.replaceAll('==', '＝').replaceAll('!=', '≠').split('=');\n\t\t// != を弾けないので中途半端ではある\n\tconst cnt_equa = equa.length;\n\tif (cnt_equa < 2 || cnt_equa > 3) throw '「&計算」書式では「=」指定が一つか二つ必要です';\n\tconst [e0, e1, e2] = equa;\n\tif (e1!.startsWith('&')) throw '「&計算」書式では「&」指定が不要です';\n\treturn {\n\t\tname: e0!.replaceAll('＝', '==').replaceAll('≠', '!='),\n\t\ttext: e1!.replaceAll('＝', '==').replaceAll('≠', '!='),\n\t\tcast: (cnt_equa === 3 ?e2!.trim() :undefined)\n\t};\n}\n\n\nexport class Grammar {\n\tconstructor(private readonly cfg: IConfig) {this.setEscape('')}\n\n\t#REG_TOKEN\t: RegExp;\n\tsetEscape(ce: string) {\n\t\tif (this.#hC2M && (ce in this.#hC2M)) throw '[エスケープ文字] char【'+ ce +'】が登録済みの括弧マクロまたは一文字マクロです';\n\n\t\t// 1083 matches (14577 step, 9.9ms) https://regex101.com/r/dP0tAY/1\n\t\t/*\n\\\\\\S |\n \\n+\n| \\t+\n|\t\\[let_ml \\s+ [^\\]]+ ]\n\t.+? (?=\\[endlet_ml [\\]\\s])\n| \\[ (?: [^\"'#;\\]]+\n\t| ([\"'#]).*?\\1\n\t| ;[^\\n]* ) *? ]\n| ;[^\\n]*\n| &[^&\\n]+&\n| &&?(?: [^\"'#;\\n&]+ | ([\"'#]).*?\\2 )+\n| ^\\*[^\\s\\[&;\\\\]+\n| [^\\n\\t\\[;\\\\]+\n\t\t*/\n/*\n\t[^\"'#;\\]]++\n\t| ([\"'\\#]).*?\\1\n\t\t\t++ にしたいところだが、jsは未サポートらしい（2022/10/16）\n*/\n\t\tthis.#REG_TOKEN = new RegExp(\n\t\t(ce\t?`\\\\${ce}\\\\S|` :'')+\t// エスケープシーケンス\n\t\t'\\\\n+'+\t\t\t\t// 改行\n\t\t'|\\\\t+'+\t\t\t// タブ文字\n\t\t`|\\\\[let_ml\\\\s+[^\\\\]]+\\\\]`+\n\t\t\t`.+?`+\t\t\t// [let_ml]〜[endlet_ml]間のテキスト\n\t\t`(?=\\\\[endlet_ml[\\\\]\\\\s])`+\n\t\t`|\\\\[(?:`+\n\t\t\t`[^\"'#;\\\\]]+|`+\t// タグ\n\t\t\t`([\"'#]).*?\\\\1` +\n\t\t\t\t// . は (?:\\\\${ ce??'\\\\' }.|[^\\\\1]) でなくてよさげ\n\t\t`|;[^\\\\n]*)*?]`+\n\t\t'|;[^\\\\n]*'+\t\t// コメント\n\t\t'|&[^&\\\\n]+&'+\t\t// ＆表示＆\n\t\t`|&&?(?:[^\"'#;\\\\n&]+|([\"'#]).*?\\\\2)+`+\t// ＆代入\n\t\t'|^\\\\*[^\\\\s\\\\[&;\\\\\\\\]+'+\t// ラベル\n\t\t`|[^\\\\n\\\\t\\\\[;${ce ?`\\\\${ce}` :''}]+`,\t\t// 本文\n\t\t'gs');\n\t\tthis.#REG_CANTC2M = new RegExp(`[\\\\w\\\\s;[\\\\]*=&｜《》${ce ?`\\\\${ce}` :''}]`);\n\t\tthis.#REG_TOKEN_NOTXT = new RegExp(`[\\\\n\\\\t;\\\\[*&${ce ?`\\\\${ce}` :''}]`);\n\t}\n\n\n\t// 括弧マクロの定義\n\tbracket2macro(hArg: HArg, hTag: IHTag, scr: Script, start_idx: number) {\n\t\tconst {name, text} = hArg;\n\t\tif (! name) throw '[bracket2macro] nameは必須です';\n\t\tif (! text) throw '[bracket2macro] textは必須です';\n\t\tconst op = text.at(0);\n\t\tif (! op) throw '[bracket2macro] textは必須です';\n\t\tif (text.length !== 2) throw '[bracket2macro] textは括弧の前後を示す二文字を指定してください';\n\t\tif (! (name in hTag)) throw `[bracket2macro] 未定義のタグ又はマクロ[${name}]です`;\n\n\t\tthis.#hC2M ??= {};\n\t\tconst cl = text.charAt(1);\n\t\tif (op in this.#hC2M) throw '[bracket2macro] text【'+ op +'】が登録済みの括弧マクロまたは一文字マクロです';\n\t\tif (cl in this.#hC2M) throw '[bracket2macro] text【'+ cl +'】が登録済みの括弧マクロまたは一文字マクロです';\n\t\tif (this.#REG_CANTC2M.test(op)) throw '[bracket2macro] text【'+ op +'】は括弧マクロに使用できない文字です';\n\t\tif (this.#REG_CANTC2M.test(cl)) throw '[bracket2macro] text【'+ cl +'】は括弧マクロに使用できない文字です';\n\n\t\tthis.#hC2M[cl] = '0';\t// チェック用ダミー\n\t\tthis.#hC2M[op] = `[${name} text=`;\n\n\t\tthis.addC2M(`\\\\${op}[^\\\\${cl}]*\\\\${cl}`, `\\\\${op}\\\\${cl}`);\n\n\t\tthis.#replaceScr_C2M(scr, start_idx);\n\t}\n\t// 一文字マクロの定義\n\tchar2macro(hArg: HArg, hTag: IHTag, scr: Script, start_idx: number) {\n\t\tconst {char, name} = hArg;\n\t\tif (! char) throw '[char2macro] charは必須です';\n\t\tthis.#hC2M ??= {};\n\t\tif (char in this.#hC2M) throw '[char2macro] char【'+ char +'】が登録済みの括弧マクロまたは一文字マクロです';\n\t\tif (this.#REG_CANTC2M.test(char)) throw '[char2macro] char【'+ char +'】は一文字マクロに使用できない文字です';\n\n\t\tif (! name) throw '[char2macro] nameは必須です';\n\t\tif (! (name in hTag)) throw `[char2macro] 未定義のタグ又はマクロ[${name}]です`;\n\n\t\tthis.#hC2M[char] = `[${name}]`;\n\n\t\tthis.addC2M(`\\\\${char}`, `\\\\${char}`);\n\n\t\tthis.#replaceScr_C2M(scr, start_idx);\n\t}\n\t#REG_CANTC2M\t: RegExp;\n\t#REGC2M\t\t\t= new RegExp('');\n\t#regStrC2M\t\t= '';\n\t#regStrC2M4not\t= '';\n\taddC2M(a: string, b: string) {\n\t\tthis.#regStrC2M += `${a}|`;\n\t\tthis.#regStrC2M4not += `${b}`;\n\t\tthis.#REGC2M = new RegExp(\n\t\t\t`(${this.#regStrC2M}[^${this.#regStrC2M4not}]+)`, 'g');\n\t}\n\n\n\tresolveScript(txt: string): Script {\n\t\tconst a = txt\n\t\t.replaceAll(/\\r\\n?/g, '\\n')\n\t\t.match(this.#REG_TOKEN)\n\t\t?.flatMap(tkn=> {\n\t\t\tif (! this.testTagLetml(tkn)) return tkn;\n\n\t\t\tconst r = /^([^\\]]+?])(.*)$/s.exec(tkn);\n\t\t\tif (! r) return tkn;\n\t\t\tconst [, a, b] = r;\n\t\t\treturn [a, b];\n\t\t}) ?? [];\n\n\t\tconst scr = {aToken: a as string[], len: a.length, aLNum: []};\n\t\tthis.#replaceScr_C2M(scr);\n\n\t\tthis.#replaceScript_Wildcard(scr);\n\n\t\treturn scr;\n\t}\n\n\n\treadonly #REG_WILDCARD\t= /^\\[(call|loadplugin)\\s/;\n\treadonly #REG_WILDCARD2\t= /\\bfn\\s*=\\s*[^\\s\\]]+/;\n\t#replaceScript_Wildcard(scr: Script) {\n\t\tfor (let i=scr.len -1; i>=0; --i) {\n\t\t\tconst token = scr.aToken[i]!;\n\t\t\tif (! this.#REG_WILDCARD.test(token)) continue;\n\n\t\t\tconst [tag_name, args] = tagToken2Name_Args(token);\n\t\t\tthis.#alzTagArg.parse(args);\n\n\t\t\tconst p_fn = this.#alzTagArg.hPrm.fn;\n\t\t\tif (! p_fn) continue;\n\t\t\tconst {val: fn} = p_fn;\n\t\t\tif (! fn || ! fn.endsWith('*')) continue;\n\n\t\t\tscr.aToken.splice(i, 1, '\\t', '; '+ token);\n\t\t\tscr.aLNum.splice(i, 1, NaN, NaN);\n\n\t\t\tconst ext = tag_name === 'loadplugin'\n\t\t\t\t? SEARCH_PATH_ARG_EXT.CSS\n\t\t\t\t: SEARCH_PATH_ARG_EXT.SN;\n\t\t\tconst a = this.cfg.matchPath('^'+ fn.slice(0, -1) +'.*', ext);\n\t\t\tfor (const v of a) {\n\t\t\t\tconst nt = token.replace(\n\t\t\t\t\tthis.#REG_WILDCARD2,\n\t\t\t\t\t'fn='+ decodeURIComponent(getFn(v[ext]!))\n\t\t\t\t);\n\t\t\t\t//console.log('\\t='+ nt +'=');\n\t\t\t\tscr.aToken.splice(i, 0, nt);\n\t\t\t\tscr.aLNum.splice(i, 0, NaN);\n\t\t\t}\n\t\t}\n\t\tscr.len = scr.aToken.length;\n\t}\n\t\treadonly\t#alzTagArg\t= new AnalyzeTagArg;\n\n\n\ttestTagLetml(tkn: string): boolean {return /^\\[let_ml\\s/.test(tkn)};\n\ttestTagEndLetml(tkn: string): boolean {return /^\\[endlet_ml\\s*]/.test(tkn)};\n\n\tanalyzToken(token: string): RegExpExecArray | null {\t// 4LspWs\n\t\tthis.#REG_TOKEN.lastIndex = 0;\t// /gなので必要\n\t\treturn this.#REG_TOKEN.exec(token);\n\t}\n\n\n\t#hC2M\t: {[char: string]: string};\n\t#REG_TOKEN_NOTXT\t: RegExp;\n\t#replaceScr_C2M(scr: Script, start_idx = 0): void {\n\t\tif (! this.#hC2M) return;\n\n\t\tfor (let i=scr.len- 1; i >= start_idx; --i) {\n\t\t\tconst token = scr.aToken[i]!;\n\t\t\tif (this.testNoTxt(token.at(0) ?? '\\n')) continue;\n\t\t\t\t// 省略時は #REG_TOKEN_NOTXT に引っかかる \\n に\n\n\t\t\tconst lnum = scr.aLNum[i]!;\n\t\t\tconst a = token.match(this.#REGC2M);\n\t\t\tif (! a) continue;\n\t\t\tlet del = 1;\n\t\t\tfor (let j=a.length -1; j>=0; --j) {\n\t\t\t\tlet ch = a[j]!;\n\t\t\t\tconst macro = this.#hC2M[ch.at(0) ?? ' '];\n\t\t\t\t\t// 省略時は #REG_CANTC2M に引っかかる ' ' に\n\t\t\t\tif (macro) {\n\t\t\t\t\tch = macro +(macro.endsWith(']')\n\t\t\t\t\t\t? ''\n\t\t\t\t\t\t: (`'${ch.slice(1, -1)}']`));\n\t\t\t\t\t// 文字列は半角空白を意識して''で囲むが、いずれ変えたい場合がある？\n\t\t\t\t}\n\t\t\t\tscr.aToken.splice(i, del, ch);\n\n\t\t\t\tscr.aLNum.splice(i, del, lnum);\n\t\t\t\tdel = 0;\n\t\t\t}\n\t\t}\n\t\tscr.len = scr.aToken.length;\n\t}\n\ttestNoTxt(ch: string): boolean {return this.#REG_TOKEN_NOTXT.test(ch)};\t//4tst\n\n}\n","/* ***** BEGIN LICENSE BLOCK *****\n\tCopyright (c) 2024-2024 Famibee (famibee.blog38.fc2.com)\n\n\tThis software is released under the MIT License.\n\thttp://opensource.org/licenses/mit-license.php\n** ***** END LICENSE BLOCK ***** */\n\nimport {SysBase} from '../SysBase';\nimport {SEARCH_PATH_ARG_EXT} from './ConfigBase';\nimport {Grammar} from './Grammar';\nimport {addLayer, chgPic, type T_LAY} from '../components/Stage';\nimport type {T_CHGPIC} from '../store/store';\n\nimport type {AssetsClass} from '@pixi/assets';\n\n\nexport class ScriptMng {\n\tconstructor(private readonly sys: SysBase, private readonly Assets: AssetsClass) {\n\t\tthis.#grm = new Grammar(sys.cfg);\n\t}\n\t\treadonly\t#grm;\n\n\tasync load(fn: string) {\n\t\tconst path = this.sys.cfg.searchPath(fn, SEARCH_PATH_ARG_EXT.SCRIPT);\n\t\tconst txt = await this.Assets.load(path);\n\t\tconst scr = this.#grm.resolveScript(txt);\nconsole.log(`fn:ScriptMng.ts line:34 1=${scr.aToken[1]}`);\n\n// NOTE: TS最新のジェネレーターみたいなので仮組み。詳細なスクリプトアナライザーなどは後に。\nfunction* generator(): Generator<T_LAY | T_CHGPIC> {\n\tyield {cls: 'GRP', nm: 'base', fn: 'yun_1184'};\n\tyield {cls: 'GRP', nm: 'fg0', fn: 'F_1024a'};\n\tyield {nm: 'base', fn: 'yun_1317'};\n}\nlet idxDummy = 0;\nfor (const o of generator()) {\n\tif ('cls' in o) addLayer(o);\n\telse chgPic(o);\n\n\tthis.sys.caretaker.key = fn + ':'+ ++idxDummy;\n}\n\n\n\t\t//NOTE: 同じidxの更新をチェックか\n\n\t\t//TODO: スクリプト解析ループ・開始\n\t\t//TODO: [l][p][s][wait]での状態を保存\n\n\t}\n\n}\n"],"names":["AnalyzeTagArg","#REG_TAGARG","args","#hPrm","#isKomeParam","groups","key","val","val2","def","def2","literal","token","lenNm","ln","ch","hRng","index","z","lenVnm","k_ch","#idx2LnCol","k_ln","v_ln","v_ch","idx","len","REG_TAG","tagToken2Name_Args","g","nm","Grammar","cfg","#REG_TOKEN","ce","#hC2M","#REG_CANTC2M","#REG_TOKEN_NOTXT","hArg","hTag","scr","start_idx","name","text","op","cl","#replaceScr_C2M","char","#REGC2M","#regStrC2M","#regStrC2M4not","a","b","txt","tkn","r","#replaceScript_Wildcard","#REG_WILDCARD","#REG_WILDCARD2","i","tag_name","#alzTagArg","p_fn","fn","ext","SEARCH_PATH_ARG_EXT","v","nt","getFn","lnum","del","j","macro","ScriptMng","sys","Assets","#grm","path","generator","idxDummy","o","addLayer"],"mappings":"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"}