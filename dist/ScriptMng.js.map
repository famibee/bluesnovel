{"version":3,"file":"ScriptMng.js","sources":["../src/ts/AnalyzeTagArg.ts","../src/ts/Grammar.ts","../src/ts/ScriptMng.ts"],"sourcesContent":["/* ***** BEGIN LICENSE BLOCK *****\n\tCopyright (c) 2018-2024 Famibee (famibee.blog38.fc2.com)\n\n\tThis software is released under the MIT License.\n\thttp://opensource.org/licenses/mit-license.php\n** ***** END LICENSE BLOCK ***** */\n\nexport interface PRM {\n\tval\t\t: string;\n\tdef?\t: string;\n};\nexport interface HPRM {\n\t[key: string]: PRM,\n};\n\nexport interface PRM_RANGE {\n\tk_ln\t: number;\n\tk_ch\t: number;\n\tv_ln\t: number;\n\tv_ch\t: number;\n\tv_len\t: number;\n};\n\nexport class AnalyzeTagArg {\n\t// 87 match 2725 step(0.5ms) PCRE2 https://regex101.com/r/aeN57J/1\n\t/*\n;[^\\n]*\n|\t(?<key>[^\\s=\"'#|;]+)\n\t(?: \\s | ;[^\\n]*\\n)*\n\t=\n\t(?: \\s | ;[^\\n]*\\n)*\n\t(?:\t(?<val> [^\\s\"'#|;]+)\n\t|\t([\"'#]) (?<val2>.*?) \\3 )\n\t(?: \\|\n\t\t(?: (?<def> [^\\s\"'#;]+)\n\t|\t([\"'#]) (?<def2>.*?) \\6 ) )?\n|\t(?<literal>[^\\s;]+)\n\t*/\n\treadonly\t#REG_TAGARG\t= /;[^\\n]*|(?<key>[^\\s=\"'#|;]+)(?:\\s|;[^\\n]*\\n)*=(?:\\s|;[^\\n]*\\n)*(?:(?<val>[^\\s\"'#|;]+)|([\"'#])(?<val2>.*?)\\3)(?:\\|(?:(?<def>[^\\s\"'#;]+)|([\"'#])(?<def2>.*?)\\6))?|(?<literal>[^\\s;]+)/g;\n\n\t// 【属性 = 値 | 省略値】の分析\n\tparse(args: string): void {\n\t\tthis.#hPrm = {};\n\t\tthis.#isKomeParam = false;\n\t\tfor (const {groups} of args.matchAll(this.#REG_TAGARG)) {\n\t\t\tconst {key, val, val2, def, def2, literal} = groups!;\n\t\t\tif (key) this.#hPrm[key] = {\n\t\t\t\tval: val ?? val2 ?? '',\n\t\t\t\tdef: def ?? def2\n\t\t\t};\n\t\t\telse if (literal) {\n\t\t\t\tif (literal === '*') this.#isKomeParam = true;\n\t\t\t\telse this.#hPrm[literal] = {val: '1'};\n\t\t\t}\n\t\t}\n\t}\n\n\t// 属性と値の位置をまとめて返す\n\tparseinDetail(token: string, lenNm: number, ln: number, ch: number): {[key: string]: PRM_RANGE} {\n\t\tconst hRng: {[key: string]: PRM_RANGE} = {};\n\n\t\tconst args = token.slice(1+lenNm, -1);\n\t\tfor (const {groups, index, 0: z} of args.matchAll(this.#REG_TAGARG)) {\n\t\t\tif (index === undefined) continue;\n\t\t\tconst {key, val, val2='', literal} = groups!;\n\t\t\tif (literal) {\n\t\t\t\tif (literal.endsWith('=')) {\n\t\t\t\t\tconst lenVnm = literal.length -1;\n\t\t\t\t\tconst {ch: k_ch} = this.#idx2LnCol(lenNm, ln, ch, args, index +lenVnm);\n\t\t\t\t\thRng[literal.slice(0, -1)] = {\n\t\t\t\t\t\tk_ln: ln,\n\t\t\t\t\t\tk_ch: k_ch -lenVnm,\n\t\t\t\t\t\tv_ln: ln,\n\t\t\t\t\t\tv_ch: k_ch +1,\n\t\t\t\t\t//\tv_ch: ch +1+lenNm +literal.length +1,\n\t\t\t\t\t\tv_len: 0,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (! key) continue;\n\n\t\t\tconst {ln: k_ln, ch: k_ch} = this.#idx2LnCol(lenNm, ln, ch, args, index);\n\t\t\tconst {ln: v_ln, ch: v_ch} = this.#idx2LnCol(lenNm, ln, ch, args, index +z.lastIndexOf(val ?? val2 ?? '') -(val ?0 :1));\n\t\t\thRng[key] = {k_ln, k_ch, v_ln, v_ch, v_len: val ?val.length :val2.length +2};\n\t\t}\n\n\t\treturn hRng;\n\t}\n\t\t#idx2LnCol(lenNm: number, ln: number, ch: number, args: string, idx: number): {ln: number; ch: number;} {\n\t\t\tconst sBefore = args.slice(0, idx);\n\t\t\tconst a = sBefore.split('\\n');\n\t\t\tconst len = a.length;\n\t\t\treturn {\n\t\t\t\tln\t: ln +len -1,\n\t\t\t\tch\t: len < 2 ?ch +1+lenNm +idx :a.at(-1)!.length,\n\t\t\t};\n\t\t}\n\n\t#hPrm: HPRM\t= {};\n\tget hPrm() {return this.#hPrm}\n\n\t#isKomeParam\t= false;\n\tget isKomeParam() {return this.#isKomeParam}\n\n}\n","/* ***** BEGIN LICENSE BLOCK *****\n\tCopyright (c) 2019-2024 Famibee (famibee.blog38.fc2.com)\n\n\tThis software is released under the MIT License.\n\thttp://opensource.org/licenses/mit-license.php\n** ***** END LICENSE BLOCK ***** */\n\nimport {AnalyzeTagArg} from './AnalyzeTagArg';\nimport {getFn} from './CmnLib';\nimport {type IConfig, SEARCH_PATH_ARG_EXT} from './ConfigBase';\n\n\nexport type HArg = {\n\t':タグ名'?\t: string;\n\n\tlayer?\t: string;\t// レイヤ系\n\tclass?\t: string;\n\tindex?\t: number;\n\tdive?\t: string;\n\tpage?\t: string;\n\talpha?\t: number;\n\tpivot_x?: number;\n\tpivot_y?: number;\n\trotation?\t: number;\n\tscale_x?: number;\n\tscale_y?: number;\n\tvisible?: boolean;\n\tblendmode?\t: string;\n\n\tleft?\t: number;\n\ttop?\t: number;\n\twidth?\t: number;\n\theight?\t: number;\n\tpl?\t\t: number;\n\tpr?\t\t: number;\n\tpt?\t\t: number;\n\tpb?\t\t: number;\n\n\trotate?\t: number;\n\tin_style?\t: string;\n\tout_style?\t: string;\n\tffs?\t: string;\n\tnoffs?\t: string;\n\tkinsoku_sol?\t: string;\n\tkinsoku_eol?\t: string;\n\tkinsoku_dns?\t: string;\n\tkinsoku_bura?\t: string;\n\tbura?\t: boolean;\n\tbreak_fixed?\t\t: boolean;\n\tbreak_fixed_left?\t: number;\n\tbreak_fixed_top?\t: number;\n\n\ttime?\t: number;\n\trule?\t: string;\n\tglsl?\t: string;\n\trender?\t: boolean;\n\n\tpos?\t: string;\n\ttext?\t: string;\n\twait?\t: number;\n\trecord?\t: boolean;\n\tpic?\t: string;\n\tenabled?: boolean;\n\thint?\t\t: string;\n\thint_style?\t: string;\n\thint_opt?\t: string;\n\tclickse?\t: string;\n\tenterse?\t: string;\n\tleavese?\t: string;\n\tclicksebuf?\t: string;\n\tentersebuf?\t: string;\n\tleavesebuf?\t: string;\n\tonenter?\t: string;\n\tonleave?\t: string;\n\n\tt?\t: string;\n\tr?\t: string;\n\texp?\t: string;\n\tchar?\t: string;\n\tsesame?\t: string;\n\tcast?\t: string;\n\tval?\t: string;\n\tflags?\t: string;\n\treg?\t: string;\n\tlen?\t: string;\n\turl?\t: string;\n\tformat?\t: string;\n\tchain?\t: string;\n\tpath?\t: string;\n\n\tfn?\t\t: string;\n\tface?\t: string;\n\tlabel?\t: string;\n\tcall?\t: boolean;\n\tglobal?\t: boolean;\n\tname?\t: string;\n\tclear_local_event?\t: boolean;\n\n\tstyle?\t\t\t: string;\n\tstyle_hover?\t: string;\n\tstyle_clicked?\t: string;\n\tr_style?\t\t: string;\n\tr_style_hover?\t: string;\n\tr_style_clicked?: string;\n\tr_align?\t: string;\n\n\tb_width?\t: string;\n\tb_height?\t: string;\n\tb_color?\t: string;\n\tb_alpha?\t: number;\n\tb_alpha_isfixed?\t: boolean;\n\tb_pic?\t\t: string;\n\tback_clear?\t: string;\n\n\tmax_col?\t: string;\n\tmax_row?\t: string;\n\tbura_col?\t: string;\n\tchk_overrow?\t: string;\n\n\tdx?\t: number;\n\tdy?\t: number;\n\n\tkey?\t: string;\n\ttype?\t: string;\t// 3Dレイヤで使用\n\tcamera_target?\t: string;\n\n\tbreakout?\t: Function;\n\targ?\t: HArg;\n\tfnc?\t: ()=> void;\n\n\tfilter?\t: string;\n\tmatrix?\t: string;\n\tclear_filter?\t: boolean;\n\tenable_filter?\t: boolean;\n\n\tease?\t: string;\n\tcanskip?\t:boolean;\n\n\tcentering?\t:boolean;\n\tx?\t\t: number | string;\n\ty?\t\t: number | string;\n\n\tid?\t\t\t: string;\n\tsrc?\t\t: string;\n\tvar_name?\t: string;\n\tset_fnc?\t: string;\n\tbreak_fnc?\t: string;\n\n\tswipe?\t: string;\n\tf2tap?\t: string;\n\tf2move?\t: string;\n\tf3tap?\t: string;\n\n\tfrom?\t: number;\n\tto?\t\t: number | string;\n\tplace?\t: number;\n\tadd?\t: string;\n\tdel?\t: string;\n\n\tbuf?\t: string;\t// 音系\n\tbuf2?\t: string;\n\tloop?\t: boolean;\n\tvolume?\t: number;\n\tret_ms?\t: number;\n\tend_ms?\t: number;\n\tjoin?\t: boolean;\n\tdo_rec?\t: boolean;\n\tpan?\t: number;\n\tstop?\t: boolean;\n\n\tclear?\t: boolean;\n\n\t// デザインモード\n\t':id_dc'?\t: string;\n\t':id_tag'?\t: string;\n\t':path'?\t: string;\n\t':ln'?\t\t: number;\n\t':col_s'?\t: number;\n\t':col_e'?\t: number;\n\t':idx_tkn'?\t: number;\n\t':token'?\t: string;\n\t':redraw'?\t: boolean;\n\tdesign_unit?: boolean;\t// デザインモードでこのマクロへの引数変更とするか（内部をサーチさせない）\n\n//\tstepin?\t\t: boolean;\t\t// 拡張機能のみ使用：false指定でステップインしない\n//\tnowarn_unused?\t: boolean;\t// 拡張機能のみ使用：未使用警告を出さない\n}\nexport interface ITag { (hArg: HArg): boolean; }\nexport interface IHTag { [name: string]: ITag; }\n\n\nexport type Script = {\n\taToken\t: string[];\t\t// トークン群\n\tlen\t\t: number;\t\t// トークン数\n\taLNum\t: number[];\t\t// トークンの行番号\n};\n\n\nexport const\tREG_TAG\t= /(?<name>[^\\s;\\]]+)/;\t// test用にexport\nexport function\ttagToken2Name_Args(token: string): [name: string, args: string] {\n\tconst e = REG_TAG.exec(token.slice(1, -1));\n\tconst g = e?.groups;\n\tif (! g) throw `タグ記述【${token}】異常です(タグ解析)`;\n\n\tconst nm = g.name!;\n\treturn [nm, token.slice(1 +nm.length, -1)];\n}\nexport function\ttagToken2Name(token: string): string {\n\tconst e = REG_TAG.exec(token.slice(1));\n\tconst g = e?.groups;\n\tif (! g) throw `タグ記述【${token}】異常です(タグ解析)`;\n\n\treturn g.name!;\n}\n\nexport function\tsplitAmpersand(token: string): {\n\t\tname: string;\n\t\ttext: string;\n\t\tcast: string | undefined;\n} {\t// テスト用にpublic\n\tconst equa = token.replaceAll('==', '＝').replaceAll('!=', '≠').split('=');\n\t\t// != を弾けないので中途半端ではある\n\tconst cnt_equa = equa.length;\n\tif (cnt_equa < 2 || cnt_equa > 3) throw '「&計算」書式では「=」指定が一つか二つ必要です';\n\tconst [e0, e1, e2] = equa;\n\tif (e1!.startsWith('&')) throw '「&計算」書式では「&」指定が不要です';\n\treturn {\n\t\tname: e0!.replaceAll('＝', '==').replaceAll('≠', '!='),\n\t\ttext: e1!.replaceAll('＝', '==').replaceAll('≠', '!='),\n\t\tcast: (cnt_equa === 3 ?e2!.trim() :undefined)\n\t};\n}\n\n\nexport class Grammar {\n\tconstructor(private readonly cfg: IConfig) {this.setEscape('')}\n\n\t#REG_TOKEN\t: RegExp;\n\tsetEscape(ce: string) {\n\t\tif (this.#hC2M && (ce in this.#hC2M)) throw '[エスケープ文字] char【'+ ce +'】が登録済みの括弧マクロまたは一文字マクロです';\n\n\t\t// 1083 matches (14577 step, 9.9ms) https://regex101.com/r/dP0tAY/1\n\t\t/*\n\\\\\\S |\n \\n+\n| \\t+\n|\t\\[let_ml \\s+ [^\\]]+ ]\n\t.+? (?=\\[endlet_ml [\\]\\s])\n| \\[ (?: [^\"'#;\\]]+\n\t| ([\"'#]).*?\\1\n\t| ;[^\\n]* ) *? ]\n| ;[^\\n]*\n| &[^&\\n]+&\n| &&?(?: [^\"'#;\\n&]+ | ([\"'#]).*?\\2 )+\n| ^\\*[^\\s\\[&;\\\\]+\n| [^\\n\\t\\[;\\\\]+\n\t\t*/\n/*\n\t[^\"'#;\\]]++\n\t| ([\"'\\#]).*?\\1\n\t\t\t++ にしたいところだが、jsは未サポートらしい（2022/10/16）\n*/\n\t\tthis.#REG_TOKEN = new RegExp(\n\t\t(ce\t?`\\\\${ce}\\\\S|` :'')+\t// エスケープシーケンス\n\t\t'\\\\n+'+\t\t\t\t// 改行\n\t\t'|\\\\t+'+\t\t\t// タブ文字\n\t\t`|\\\\[let_ml\\\\s+[^\\\\]]+\\\\]`+\n\t\t\t`.+?`+\t\t\t// [let_ml]〜[endlet_ml]間のテキスト\n\t\t`(?=\\\\[endlet_ml[\\\\]\\\\s])`+\n\t\t`|\\\\[(?:`+\n\t\t\t`[^\"'#;\\\\]]+|`+\t// タグ\n\t\t\t`([\"'#]).*?\\\\1` +\n\t\t\t\t// . は (?:\\\\${ ce??'\\\\' }.|[^\\\\1]) でなくてよさげ\n\t\t`|;[^\\\\n]*)*?]`+\n\t\t'|;[^\\\\n]*'+\t\t// コメント\n\t\t'|&[^&\\\\n]+&'+\t\t// ＆表示＆\n\t\t`|&&?(?:[^\"'#;\\\\n&]+|([\"'#]).*?\\\\2)+`+\t// ＆代入\n\t\t'|^\\\\*[^\\\\s\\\\[&;\\\\\\\\]+'+\t// ラベル\n\t\t`|[^\\\\n\\\\t\\\\[;${ce ?`\\\\${ce}` :''}]+`,\t\t// 本文\n\t\t'gs');\n\t\tthis.#REG_CANTC2M = new RegExp(`[\\\\w\\\\s;[\\\\]*=&｜《》${ce ?`\\\\${ce}` :''}]`);\n\t\tthis.#REG_TOKEN_NOTXT = new RegExp(`[\\\\n\\\\t;\\\\[*&${ce ?`\\\\${ce}` :''}]`);\n\t}\n\n\n\t// 括弧マクロの定義\n\tbracket2macro(hArg: HArg, hTag: IHTag, scr: Script, start_idx: number) {\n\t\tconst {name, text} = hArg;\n\t\tif (! name) throw '[bracket2macro] nameは必須です';\n\t\tif (! text) throw '[bracket2macro] textは必須です';\n\t\tconst op = text.at(0);\n\t\tif (! op) throw '[bracket2macro] textは必須です';\n\t\tif (text.length !== 2) throw '[bracket2macro] textは括弧の前後を示す二文字を指定してください';\n\t\tif (! (name in hTag)) throw `[bracket2macro] 未定義のタグ又はマクロ[${name}]です`;\n\n\t\tthis.#hC2M ??= {};\n\t\tconst cl = text.charAt(1);\n\t\tif (op in this.#hC2M) throw '[bracket2macro] text【'+ op +'】が登録済みの括弧マクロまたは一文字マクロです';\n\t\tif (cl in this.#hC2M) throw '[bracket2macro] text【'+ cl +'】が登録済みの括弧マクロまたは一文字マクロです';\n\t\tif (this.#REG_CANTC2M.test(op)) throw '[bracket2macro] text【'+ op +'】は括弧マクロに使用できない文字です';\n\t\tif (this.#REG_CANTC2M.test(cl)) throw '[bracket2macro] text【'+ cl +'】は括弧マクロに使用できない文字です';\n\n\t\tthis.#hC2M[cl] = '0';\t// チェック用ダミー\n\t\tthis.#hC2M[op] = `[${name} text=`;\n\n\t\tthis.addC2M(`\\\\${op}[^\\\\${cl}]*\\\\${cl}`, `\\\\${op}\\\\${cl}`);\n\n\t\tthis.#replaceScr_C2M(scr, start_idx);\n\t}\n\t// 一文字マクロの定義\n\tchar2macro(hArg: HArg, hTag: IHTag, scr: Script, start_idx: number) {\n\t\tconst {char, name} = hArg;\n\t\tif (! char) throw '[char2macro] charは必須です';\n\t\tthis.#hC2M ??= {};\n\t\tif (char in this.#hC2M) throw '[char2macro] char【'+ char +'】が登録済みの括弧マクロまたは一文字マクロです';\n\t\tif (this.#REG_CANTC2M.test(char)) throw '[char2macro] char【'+ char +'】は一文字マクロに使用できない文字です';\n\n\t\tif (! name) throw '[char2macro] nameは必須です';\n\t\tif (! (name in hTag)) throw `[char2macro] 未定義のタグ又はマクロ[${name}]です`;\n\n\t\tthis.#hC2M[char] = `[${name}]`;\n\n\t\tthis.addC2M(`\\\\${char}`, `\\\\${char}`);\n\n\t\tthis.#replaceScr_C2M(scr, start_idx);\n\t}\n\t#REG_CANTC2M\t: RegExp;\n\t#REGC2M\t\t\t= new RegExp('');\n\t#regStrC2M\t\t= '';\n\t#regStrC2M4not\t= '';\n\taddC2M(a: string, b: string) {\n\t\tthis.#regStrC2M += `${a}|`;\n\t\tthis.#regStrC2M4not += `${b}`;\n\t\tthis.#REGC2M = new RegExp(\n\t\t\t`(${this.#regStrC2M}[^${this.#regStrC2M4not}]+)`, 'g');\n\t}\n\n\n\tresolveScript(txt: string): Script {\n\t\tconst a = txt\n\t\t.replaceAll(/\\r\\n?/g, '\\n')\n\t\t.match(this.#REG_TOKEN)\n\t\t?.flatMap(tkn=> {\n\t\t\tif (! this.testTagLetml(tkn)) return tkn;\n\n\t\t\tconst r = /^([^\\]]+?])(.*)$/s.exec(tkn);\n\t\t\tif (! r) return tkn;\n\t\t\tconst [, a, b] = r;\n\t\t\treturn [a, b];\n\t\t}) ?? [];\n\n\t\tconst scr = {aToken: a as string[], len: a.length, aLNum: []};\n\t\tthis.#replaceScr_C2M(scr);\n\n\t\tthis.#replaceScript_Wildcard(scr);\n\n\t\treturn scr;\n\t}\n\n\n\treadonly #REG_WILDCARD\t= /^\\[(call|loadplugin)\\s/;\n\treadonly #REG_WILDCARD2\t= /\\bfn\\s*=\\s*[^\\s\\]]+/;\n\t#replaceScript_Wildcard(scr: Script) {\n\t\tfor (let i=scr.len -1; i>=0; --i) {\n\t\t\tconst token = scr.aToken[i]!;\n\t\t\tif (! this.#REG_WILDCARD.test(token)) continue;\n\n\t\t\tconst [tag_name, args] = tagToken2Name_Args(token);\n\t\t\tthis.#alzTagArg.parse(args);\n\n\t\t\tconst p_fn = this.#alzTagArg.hPrm.fn;\n\t\t\tif (! p_fn) continue;\n\t\t\tconst {val: fn} = p_fn;\n\t\t\tif (! fn || ! fn.endsWith('*')) continue;\n\n\t\t\tscr.aToken.splice(i, 1, '\\t', '; '+ token);\n\t\t\tscr.aLNum.splice(i, 1, NaN, NaN);\n\n\t\t\tconst ext = tag_name === 'loadplugin'\n\t\t\t\t? SEARCH_PATH_ARG_EXT.CSS\n\t\t\t\t: SEARCH_PATH_ARG_EXT.SN;\n\t\t\tconst a = this.cfg.matchPath('^'+ fn.slice(0, -1) +'.*', ext);\n\t\t\tfor (const v of a) {\n\t\t\t\tconst nt = token.replace(\n\t\t\t\t\tthis.#REG_WILDCARD2,\n\t\t\t\t\t'fn='+ decodeURIComponent(getFn(v[ext]!))\n\t\t\t\t);\n\t\t\t\t//console.log('\\t='+ nt +'=');\n\t\t\t\tscr.aToken.splice(i, 0, nt);\n\t\t\t\tscr.aLNum.splice(i, 0, NaN);\n\t\t\t}\n\t\t}\n\t\tscr.len = scr.aToken.length;\n\t}\n\t\treadonly\t#alzTagArg\t= new AnalyzeTagArg;\n\n\n\ttestTagLetml(tkn: string): boolean {return /^\\[let_ml\\s/.test(tkn)};\n\ttestTagEndLetml(tkn: string): boolean {return /^\\[endlet_ml\\s*]/.test(tkn)};\n\n\tanalyzToken(token: string): RegExpExecArray | null {\t// 4LspWs\n\t\tthis.#REG_TOKEN.lastIndex = 0;\t// /gなので必要\n\t\treturn this.#REG_TOKEN.exec(token);\n\t}\n\n\n\t#hC2M\t: {[char: string]: string};\n\t#REG_TOKEN_NOTXT\t: RegExp;\n\t#replaceScr_C2M(scr: Script, start_idx = 0): void {\n\t\tif (! this.#hC2M) return;\n\n\t\tfor (let i=scr.len- 1; i >= start_idx; --i) {\n\t\t\tconst token = scr.aToken[i]!;\n\t\t\tif (this.testNoTxt(token.at(0) ?? '\\n')) continue;\n\t\t\t\t// 省略時は #REG_TOKEN_NOTXT に引っかかる \\n に\n\n\t\t\tconst lnum = scr.aLNum[i]!;\n\t\t\tconst a = token.match(this.#REGC2M);\n\t\t\tif (! a) continue;\n\t\t\tlet del = 1;\n\t\t\tfor (let j=a.length -1; j>=0; --j) {\n\t\t\t\tlet ch = a[j]!;\n\t\t\t\tconst macro = this.#hC2M[ch.at(0) ?? ' '];\n\t\t\t\t\t// 省略時は #REG_CANTC2M に引っかかる ' ' に\n\t\t\t\tif (macro) {\n\t\t\t\t\tch = macro +(macro.endsWith(']')\n\t\t\t\t\t\t? ''\n\t\t\t\t\t\t: (`'${ch.slice(1, -1)}']`));\n\t\t\t\t\t// 文字列は半角空白を意識して''で囲むが、いずれ変えたい場合がある？\n\t\t\t\t}\n\t\t\t\tscr.aToken.splice(i, del, ch);\n\n\t\t\t\tscr.aLNum.splice(i, del, lnum);\n\t\t\t\tdel = 0;\n\t\t\t}\n\t\t}\n\t\tscr.len = scr.aToken.length;\n\t}\n\ttestNoTxt(ch: string): boolean {return this.#REG_TOKEN_NOTXT.test(ch)};\t//4tst\n\n}\n","/* ***** BEGIN LICENSE BLOCK *****\n\tCopyright (c) 2024-2024 Famibee (famibee.blog38.fc2.com)\n\n\tThis software is released under the MIT License.\n\thttp://opensource.org/licenses/mit-license.php\n** ***** END LICENSE BLOCK ***** */\n\nimport type {SysBase} from './SysBase';\nimport {SEARCH_PATH_ARG_EXT} from './ConfigBase';\nimport {Grammar, type Script, type HArg, type IHTag, tagToken2Name} from './Grammar';\nimport type {T_LAY} from '../components/Stage';\nimport type {T_CHGPIC, T_CHGSTR, T_INIT_FNCS} from '../store/store';\nimport {CmnLib} from './CmnLib';\n\ntype T_TRACE = (txt: string, lvl?: 'D'|'W'|'F'|'E'|'I'|'ET')=> void;\n\n\nexport class ScriptMng {\n\treadonly\t#grm;\n\t\t\t\t#spnDbg\t: HTMLSpanElement;\n\n\tconstructor(private readonly sys: SysBase) {\n\t\tthis.#grm = new Grammar(sys.cfg);\n\t\tthis.#hTag.trace\t\t= o=> this.#trace(o);\t\t\t// デバッグ表示へ出力\n\n\t\tthis.#spnDbg = document.createElement('span');\n\t\tthis.#spnDbg.hidden = true;\n\t\tthis.#spnDbg.textContent = '';\n\t\tthis.#spnDbg.style.cssText =\n\t\t`\tz-index: ${Number.MAX_SAFE_INTEGER};\n\t\t\tposition: absolute; left: 0; top: 0;\n\t\t\tcolor: black;\n\t\t\tbackground-color: rgba(255, 255, 255, 0.7);`\n\t\tdocument.body.appendChild(this.#spnDbg);\n\t}\n\n\t// Main.tsx からの初期化\n\tattachTsx(trgNext: ()=> void, fncs: T_INIT_FNCS, hTag: IHTag) {\n\t\tthis.$trgNext = trgNext;\n\t\tthis.$fncs = fncs;\n\t\tthis.#hTag = hTag;\n\t}\n\t\t$trgNext\t: ()=> void;\n\t\t$fncs\t\t: T_INIT_FNCS;\n\t\t#hTag\t\t: IHTag\t\t= Object.create(null);\t// タグ処理辞書\n\n\n\t\t#script\t\t: Script\t= {aToken: [''], len: 1, aLNum: [1]};\n\t\t#scriptFn\t= '';\n\t\t#idxToken\t= 0;\n\t\t#lineNum\t= 0;\n\tasync load(fn: string) {\n\t\tthis.#scriptFn = fn;\n\t\tconst path = this.sys.cfg.searchPath(fn, SEARCH_PATH_ARG_EXT.SCRIPT);\n\t\tconst txt = await this.sys.load(path);\n\t\tthis.#script = this.#grm.resolveScript(txt);\n\n\t\tthis.#idxToken = 0;\t//TODO: idx jump\n\t\tthis.#lineNum = 1;\n\n\t\t//NOTE: 同じidxの更新をチェックか\n\n\t\t//TODO: スクリプト解析ループ・開始\n\t\t//TODO: [l][p][s][wait]での状態を保存\n\n\t\tconst gen = this.#script.aToken.slice(this.#idxToken).values();\n\t\twhile (true) {\n\t\t\tconst {done, value} = gen.next();\n\t\t\tif (done) {this.myTrace('🍇 スクリプト末尾', 'E'); break;}\n\t\t\t++this.#idxToken;\n\n\t\t\tlet token = value;\n// console.log(`fn:ScriptMng.ts 🍉 %o`, token);\n\t\t\tswitch (value.charAt(0)) {\n\t\t\t\tcase '\\t':\tcontinue;\t//  タブ\n\n\t\t\t\tcase '\\n':\t// 改行\n\t\t\t\t\tthis.#lineNum += token.length;\tcontinue;\n\n\t\t\t\tcase '[':\t{\t// タグ開始\nconsole.log(`fn:ScriptMng.ts 🍊 TAG ${token}`);\n\t\t\t\t\t// if (this.#scrItr.isBreak(token)) return;\t//TODO: \n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst cl = (token.match(/\\n/g) ?? []).length;\n\t\t\t\t\t\tif (cl > 0) this.#lineNum += cl;\n\t\t\t\t\t\t// if (this.#scrItr.タグ解析(token)) {this.stop(); return}\t//TODO: \n\t\t\t\t\t}\n\t\t\t\t\tcatch (e) {\n\t\t\t\t\t\tif (e instanceof Error) this.myTrace(`[${tagToken2Name(token)}]タグ解析中例外 mes=${e.message}(${e.name})`);\n\t\t\t\t\t\telse this.myTrace(String(e));\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\tcontinue;\n\n\t\t\t\tcase '&':\t{\t//  変数操作・変数表示\n\t\t\t\t\ttry {\n\t\t\t\t\t\tif (! value.endsWith('&')) {\t//変数操作\n\t\t\t\t\t\t\t//TODO: 変数計算\n\t\t\t\t\t\t\t// if (this.#scrItr.isBreak(token)) return;\n\t\t\t\t\t\t\t// const o = splitAmpersand(token.slice(1));\n\t\t\t\t\t\t\t// o.name = this.#getValAmpersand(o.name);\n\t\t\t\t\t\t\t// o.text = String(this.#parse(o.text));\n\t\t\t\t\t\t\t// this.#hTag.let!(o);\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (value.charAt(1) === '&') throw new Error('「&表示&」書式では「&」指定が不要です');\n\t\t\t\t\t\t// token = String(this.#parse( token.slice(1, -1) ));\t//TODO: \n\t\t\t\t\t}\n\t\t\t\t\tcatch (err) {\n\t\t\t\t\t\tthis.myTrace(\n\t\t\t\t\t\t\terr instanceof Error\n\t\t\t\t\t\t\t\t? `& 変数操作・表示 mes=${err.message}(${err.name})`\n\t\t\t\t\t\t\t\t: String(err)\n\t\t\t\t\t\t);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\tbreak;\n\n\t\t\t\tcase ';':\tcontinue;\t// コメント\n\n\t\t\t\tcase '*':\t\t//  ラベル\n\t\t\t\t\tif (value.length > 1) continue;\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t//TODO: 文字表示\n\t\t\ttry {\n\t\t\t\t// this.#layMng.setNormalChWait();\t//TODO: \n\t\t\t\t// const tl = this.#layMng.currentTxtlayForeNeedErr;\n\t\t\t\t// tl.tagCh(token);\nconsole.log(`fn:ScriptMng.ts 🍈 tagCh:${token}`);\n\t\t\t}\n\t\t\tcatch (err) {\n\t\t\t\tthis.myTrace(\n\t\t\t\t\terr instanceof Error\n\t\t\t\t\t\t? `文字表示 mes=${err.message}(${err.name})`\n\t\t\t\t\t\t: String(err)\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\n\n\t\tfunction* gene1(): Generator<T_LAY | T_CHGPIC | T_CHGSTR> {\n\t\t\tyield {cls: 'GRP', nm: 'base', fn: 'yun_1184'};\n\t\t\tyield {cls: 'TXT', nm: 'mes', str: 'あいうえお'};\n\t\t\tyield {nm: 'mes', str: 'かきくけこ'};\n\t\t\tyield {cls: 'GRP', nm: 'fg0', fn: 'F_1024a'};\n\t\t\tyield {nm: 'base', fn: 'yun_1317'};\n\t\t}\n\t\tconst gen1 = gene1();\n\t\tlet idxDummy = 0;\n\t\tthis.go = ()=> {\nconsole.log(`fn:ScriptMng.ts == go ==`);\n\t\t\twhile (true) {\n\t\t\t\tconst {done, value: o} = gen1.next();\n\t\t\t\tif (done) break;\n\t\n\t\t\t\tthis.sys.caretaker.push(fn +':'+ ++idxDummy);\n\t\t\t\tif ('cls' in o) this.$fncs.addLayer(o); else\n\t\t\t\tif ('fn' in o) this.$fncs.chgPic(o); else this.$fncs.chgStr(o);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t};\n\n\t\tthis.$trgNext();\n\t}\n\n\tgo() {}\n\n\n\t#trace(hArg: HArg) {\n\t\tthis.myTrace(hArg.text || `(text is ${hArg.text})`, 'I');\n\n\t\treturn false;\n\t}\n\treadonly\tmyTrace: T_TRACE = (txt, lvl = 'E')=> {\n\t\tlet mes = `{${lvl}} `+ this.#strPos() + txt;\n\t\tthis.#dspDbg(mes, lvl);\n\n\t\tlet sty = '';\n\t\tswitch (lvl) {\n\t\t\tcase 'D':\tsty = `color:#${CmnLib.isDarkMode ?'49F' :'05A'};`;\tbreak;\n\t\t\tcase 'W':\tsty = 'color:#F80;';\tbreak;\n\t\t\tcase 'F':\tsty = 'color:#B00;';\tbreak;\n\t\t\tcase 'ET':\n\t\t\tcase 'E':\n\t\t\t\t// this.#hTag.title!({text: txt});\t//TODO: \n\t\t\t\t/*if (CmnLib.osName === \"AND\") {\n\t\t\t\t\tconst buf = \"mailto:foo@hoge.co.jp\"\n\t\t\t\t\t\t+ \"?subject=AIRNovel_ERR&body=\"\n\t\t\t\t\t\t+ CmnLib.escapeZenkaku(mes) + \"\\n\"\n\t\t\t\t\t\t+ \"※一部記号は全角表示しています。\";\n\t\t\t\t\tflash.net.navigateToURL(new URLRequest(buf));\n\t\t\t\t}*/\n\t\t\t\t// this.#hTag.dump_lay!({});\t//TODO: \n\t\t\t\t// this.#hTag.dump_val!({});\t//TODO: \n\t\t\t\tthis.dumpErrForeLine();\n\t\t\t\t// this.#hTag.dump_stack!({});\t//TODO: \n\n\t\t\t\tif (lvl === 'ET') throw mes;\n\t\t\t\tconsole.error('%c'+ mes, 'color:#F30;');\treturn;\n\t\t\tdefault:\tsty = '';\tmes = ' '+ mes;\n\t\t}\n\t\tconsole.info('%c'+ mes, sty);\n\t}\n\t\t#strPos = ()=> this.#lineNum > 0\n\t\t\t? `(fn:${this.#scriptFn} line:${this.#lineNum}) `\n\t\t\t: '';\n\t\treadonly\t#dspDbg: T_TRACE = (mes, lvl)=> {\n\t\t\tlet sty = '';\n\t\t\tswitch (lvl) {\n\t\t\t\tcase 'D':\tsty = 'color:#05A;';\tbreak;\n\t\t\t\tcase 'W':\tsty = 'color:#F80;';\tbreak;\n\t\t\t\tcase 'F':\tsty = 'color:#B00;';\tbreak;\n\t\t\t\tcase 'ET':\n\t\t\t\tcase 'E':\tsty = 'color:#F30;';\tbreak;\n\t\t\t\tdefault:\tsty = '';\n\t\t\t}\n\t\t\tthis.#spnDbg.innerHTML += `<span style='${sty}'>${mes}</span><br/>`;\n\t\t\tthis.#spnDbg.hidden = false;\n\t\t};\n\n\t#dumpErrLine = 5;\t//TODO: \n\tdumpErrForeLine() {\n\t\tif (this.#idxToken === 0) {\n\t\t\tconsole.group(`🥟 Error line (from 0 rows before) fn:${this.#scriptFn}`);\n\t\t\tconsole.groupEnd();\n\t\t\treturn;\n\t\t}\n\n\t\tlet s = '';\n\t\tfor (let i=this.#idxToken -1; i>=0; --i) {\n\t\t\ts = this.#script.aToken[i] + s;\n\t\t\tif ((s.match(/\\n/g) ?? []).length >= this.#dumpErrLine) break;\n\t\t}\n\t\tconst a = s.split('\\n').slice(-this.#dumpErrLine);\n\t\tconst len = a.length;\n\t\tconsole.group(`🥟 Error line (from ${len} rows before) fn:${this.#scriptFn}`);\n\t\tconst ln_txt_width = String(this.#lineNum).length;\n\t\tconst lc = this.#cnvIdx2lineCol(this.#script, this.#idxToken);\n\t\tfor (let i=0; i<len; ++i) {\n\t\t\tconst ln = this.#lineNum -len +i +1;\n\t\t\tconst mes = `${String(ln).padStart(ln_txt_width, ' ')}: %c`;\n\t\t\tconst e = a[i]!;\n\t\t\tconst line = (e.length > 75) ?e.slice(0, 75) +'…' :e;\t// 長い場合は後略\n\t\t\tif (i === len -1) console.info(\n\t\t\t\tmes + line.slice(0, lc.col_s) +'%c'+ line.slice(lc.col_s),\n\t\t\t\t'color: black; background-color: skyblue;', 'color: black; background-color: pink;'\n\t\t\t)\n\t\t\telse console.info(mes + line, 'color: black; background-color: skyblue;');\n\t\t}\n\t\tconsole.groupEnd();\n\t\t//console.log('Linkの出力   : %o', 'file:///Volumes/MacHD2/_Famibee/SKYNovel/prj/mat/main.sn');\n\t}\n\t\t#cnvIdx2lineCol(st: Script, idx: number): {ln: number, col_s: number, col_e: number} {\n\t\t\tconst ret = {ln: 1, col_s: 0, col_e: 0};\n\t\t\tif (! st) return ret;\n\n\t\t\tlet i = idx -1;\n\t\t\tconst lN = ret.ln = st.aLNum[i]!;\n\t\t\twhile (st.aLNum[i] === lN) {\n\t\t\t\tif (! st.aToken[i]!.startsWith('\\n')) {\n\t\t\t\t\tconst len = st.aToken[i]!.length;\n// console.log(`fn:ScriptMng.ts line:269 cnvIdx2lineCol tkn:${st.aToken[i]} len:${len} s:${ret.col_s} e:${ret.col_e}`);\n\t\t\t\t\tif (ret.col_e > 0) ret.col_s += len;\n\t\t\t\t\tret.col_e += len;\n\t\t\t\t}\n\t\t\t\tif (--i < 0) break;\n\t\t\t}\n\n\t\t\treturn ret;\n\t\t}\n\n}\n"],"names":["AnalyzeTagArg","#REG_TAGARG","args","#hPrm","#isKomeParam","groups","key","val","val2","def","def2","literal","token","lenNm","ln","ch","hRng","index","z","lenVnm","k_ch","#idx2LnCol","k_ln","v_ln","v_ch","idx","a","len","REG_TAG","tagToken2Name_Args","g","nm","tagToken2Name","Grammar","cfg","#REG_TOKEN","ce","#hC2M","#REG_CANTC2M","#REG_TOKEN_NOTXT","hArg","hTag","scr","start_idx","name","text","op","cl","#replaceScr_C2M","char","#REGC2M","#regStrC2M","#regStrC2M4not","b","txt","tkn","r","#replaceScript_Wildcard","#REG_WILDCARD","#REG_WILDCARD2","i","tag_name","#alzTagArg","p_fn","fn","ext","SEARCH_PATH_ARG_EXT","v","nt","getFn","lnum","del","j","macro","ScriptMng","sys","#grm","#hTag","o","#trace","#spnDbg","trgNext","fncs","#script","#scriptFn","#idxToken","#lineNum","path","gen","done","value","e","err","gene1","gen1","idxDummy","lvl","mes","#strPos","#dspDbg","sty","#dumpErrLine","s","ln_txt_width","lc","#cnvIdx2lineCol","line","st","ret","lN"],"mappings":"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"}